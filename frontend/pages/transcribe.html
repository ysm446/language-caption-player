<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Language Caption Player</title>
  <link rel="stylesheet" href="../css/common.css">
  <style>
    body { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    .header h1::before { content: 'ğŸ¬ '; }

    .main {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 680px;
      margin: 0 auto;
      width: 100%;
    }

    /* ---------- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ ---------- */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(74, 158, 255, 0.05);
    }
    .drop-zone .icon { font-size: 36px; margin-bottom: 8px; }
    .drop-zone .hint { color: var(--text-dim); font-size: 13px; margin-top: 4px; }

    /* ---------- é¸æŠæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ« ---------- */
    .file-info {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--surface2);
      border-radius: var(--radius);
      font-size: 13px;
    }
    .file-info.visible { display: flex; }
    .file-info .filename { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-info .change-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .file-info .change-btn:hover { color: var(--text); background: var(--border); }

    /* ---------- è¨€èªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ ---------- */
    .lang-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .lang-row label { color: var(--text-dim); font-size: 13px; white-space: nowrap; }
    .lang-row select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: var(--radius);
      font-size: 13px;
      cursor: pointer;
    }

    /* ---------- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ---------- */
    .section-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
    }

    .result-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-dim);
    }
    .result-row.done { color: var(--success); }
    .result-row.error { color: var(--error); }
    .result-path {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    /* ---------- Open Player ãƒœã‚¿ãƒ³ ---------- */
    .open-player-wrap {
      display: none;
      padding-top: 8px;
    }
    .open-player-wrap.visible { display: block; }
    .btn-open-player {
      width: 100%;
      justify-content: center;
      font-size: 15px;
      padding: 13px;
    }

    /* ---------- ç›´æ¥ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é–‹ããƒœã‚¿ãƒ³ ---------- */
    .direct-player-wrap {
      padding-top: 4px;
    }
    .btn-direct-player {
      width: 100%;
      justify-content: center;
      font-size: 14px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Language Caption Player</h1>
  </header>

  <main class="main">
    <!-- â‘  å‹•ç”»é¸æŠ -->
    <div>
      <div class="drop-zone" id="dropZone">
        <div class="icon">ğŸ“‚</div>
        <div>å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
        <div class="hint">MP4 / MKV / AVI / MOV / WebM</div>
      </div>
      <div class="file-info" id="fileInfo">
        <span>ğŸ¬</span>
        <span class="filename" id="fileName"></span>
        <button class="change-btn" id="changeBtn">å¤‰æ›´</button>
      </div>
    </div>

    <!-- â‘¡ è¨€èªè¨­å®š -->
    <div class="lang-row">
      <label>éŸ³å£°è¨€èªï¼š</label>
      <select id="langSelect">
        <option value="">è‡ªå‹•æ¤œå‡º</option>
        <option value="en">English</option>
        <option value="zh">ä¸­æ–‡</option>
        <option value="ko">í•œêµ­ì–´</option>
        <option value="fr">FranÃ§ais</option>
        <option value="de">Deutsch</option>
        <option value="es">EspaÃ±ol</option>
        <option value="ja">æ—¥æœ¬èª</option>
      </select>
    </div>

    <!-- â‘¢ æ–‡å­—èµ·ã“ã— -->
    <div class="card">
      <div class="section-label">â‘  æ–‡å­—èµ·ã“ã—</div>
      <button class="btn btn-primary" id="transcribeBtn" disabled>
        ğŸ™ï¸ å­—å¹•ã‚’ç”Ÿæˆ
      </button>
      <div class="progress-wrap" id="transcribeProgress" style="display:none">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="transcribeFill"></div></div>
        <div class="progress-label" id="transcribeLabel">æº–å‚™ä¸­...</div>
      </div>
      <div class="result-row" id="transcribeResult"></div>
    </div>

    <!-- â‘£ æ—¥æœ¬èªç¿»è¨³ -->
    <div class="card">
      <div class="section-label">â‘¡ æ—¥æœ¬èªå­—å¹•ã‚’ç”Ÿæˆ</div>
      <button class="btn btn-primary" id="translateBtn" disabled>
        ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªå­—å¹•ã‚’ç”Ÿæˆ
      </button>
      <div class="progress-wrap" id="translateProgress" style="display:none">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="translateFill"></div></div>
        <div class="progress-label" id="translateLabel">æº–å‚™ä¸­...</div>
      </div>
      <div class="result-row" id="translateResult"></div>
    </div>

    <!-- â‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§é–‹ã -->
    <div class="open-player-wrap" id="openPlayerWrap">
      <button class="btn btn-success btn-open-player" id="openPlayerBtn">
        â–¶ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§é–‹ã
      </button>
    </div>

    <!-- â‘¥ å­—å¹•ç”Ÿæˆæ¸ˆã¿ã®å‹•ç”»ã‚’ç›´æ¥é–‹ã -->
    <div class="direct-player-wrap">
      <button class="btn btn-ghost btn-direct-player" id="directPlayerBtn">
        ğŸ“‚ å­—å¹•ç”Ÿæˆæ¸ˆã¿ã®å‹•ç”»ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§é–‹ã
      </button>
    </div>
  </main>

  <script>
    const API = 'http://127.0.0.1:8765'

    let videoPath = null
    let origSrtPath = null
    let jpSrtPath = null

    // ---------- å‹•ç”»é¸æŠ ----------
    const dropZone  = document.getElementById('dropZone')
    const fileInfo  = document.getElementById('fileInfo')
    const fileName  = document.getElementById('fileName')
    const changeBtn = document.getElementById('changeBtn')

    async function selectVideo() {
      const p = await window.electronAPI.openVideo()
      if (p) setVideo(p)
    }

    function setVideo(p) {
      videoPath = p
      fileName.textContent = p.split(/[\\/]/).pop()
      dropZone.style.display = 'none'
      fileInfo.classList.add('visible')
      document.getElementById('transcribeBtn').disabled = false
      // ãƒªã‚»ãƒƒãƒˆ
      origSrtPath = jpSrtPath = null
      resetSection('transcribe')
      resetSection('translate')
      document.getElementById('openPlayerWrap').classList.remove('visible')
    }

    dropZone.addEventListener('click', selectVideo)
    changeBtn.addEventListener('click', selectVideo)

    dropZone.addEventListener('dragover', e => {
      e.preventDefault(); dropZone.classList.add('drag-over')
    })
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'))
    dropZone.addEventListener('drop', e => {
      e.preventDefault()
      dropZone.classList.remove('drag-over')
      const file = e.dataTransfer.files[0]
      if (file) setVideo(file.path)
    })

    // ---------- ãƒ˜ãƒ«ãƒ‘ãƒ¼ ----------
    function resetSection(kind) {
      document.getElementById(`${kind}Progress`).style.display = 'none'
      document.getElementById(`${kind}Fill`).style.width = '0%'
      document.getElementById(`${kind}Result`).innerHTML = ''
    }

    function setProgress(kind, pct, label) {
      document.getElementById(`${kind}Progress`).style.display = 'block'
      document.getElementById(`${kind}Fill`).style.width = pct + '%'
      document.getElementById(`${kind}Label`).textContent = label
    }

    function setResult(kind, ok, text) {
      const el = document.getElementById(`${kind}Result`)
      el.className = 'result-row ' + (ok ? 'done' : 'error')
      el.innerHTML = ok
        ? `<span>âœ“</span><span class="result-path" title="${text}">${text.split(/[\\/]/).pop()}</span>`
        : `<span>âœ—</span><span>${text}</span>`
    }

    // ---------- SSE ã‚¹ãƒˆãƒªãƒ¼ãƒ èª­ã¿è¾¼ã¿ ----------
    async function readSSE(response, onEvent) {
      const reader = response.body.getReader()
      const decoder = new TextDecoder()
      let buf = ''
      while (true) {
        const { done, value } = await reader.read()
        if (done) break
        buf += decoder.decode(value, { stream: true })
        const lines = buf.split('\n')
        buf = lines.pop()
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try { onEvent(JSON.parse(line.slice(6))) } catch {}
          }
        }
      }
    }

    // ---------- â‘  æ–‡å­—èµ·ã“ã— ----------
    document.getElementById('transcribeBtn').addEventListener('click', async () => {
      const btn = document.getElementById('transcribeBtn')
      btn.disabled = true
      resetSection('transcribe')
      setProgress('transcribe', 10, 'éŸ³å£°ã‚’æŠ½å‡ºä¸­...')

      try {
        const lang = document.getElementById('langSelect').value || null
        const res = await fetch(`${API}/transcribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ video_path: videoPath, language: lang }),
        })
        await readSSE(res, event => {
          if (event.status === 'extracting_audio') {
            setProgress('transcribe', 20, 'éŸ³å£°ã‚’æŠ½å‡ºä¸­...')
          } else if (event.status === 'saving_srt') {
            setProgress('transcribe', 80, `SRT ã‚’ç”Ÿæˆä¸­ (${event.segments} ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ)`)
          } else if (event.status === 'done') {
            setProgress('transcribe', 100, 'å®Œäº†')
            origSrtPath = event.srt_path
            setResult('transcribe', true, origSrtPath)
            document.getElementById('translateBtn').disabled = false
          } else if (event.status === 'error') {
            setResult('transcribe', false, event.message)
          }
        })
      } catch (e) {
        setResult('transcribe', false, `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${e.message}`)
      }
      btn.disabled = false
    })

    // ---------- â‘¡ æ—¥æœ¬èªç¿»è¨³ ----------
    document.getElementById('translateBtn').addEventListener('click', async () => {
      const btn = document.getElementById('translateBtn')
      btn.disabled = true
      resetSection('translate')
      setProgress('translate', 0, 'ç¿»è¨³ã‚’é–‹å§‹ä¸­...')

      try {
        const res = await fetch(`${API}/translate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ srt_path: origSrtPath }),
        })
        await readSSE(res, event => {
          if (event.status === 'translating') {
            const pct = event.total > 0 ? Math.round(event.current / event.total * 100) : 0
            setProgress('translate', pct, `ç¿»è¨³ä¸­ ${event.current} / ${event.total}`)
          } else if (event.status === 'done') {
            setProgress('translate', 100, 'å®Œäº†')
            jpSrtPath = event.srt_path
            setResult('translate', true, jpSrtPath)
            document.getElementById('openPlayerWrap').classList.add('visible')
          } else if (event.status === 'error') {
            setResult('translate', false, event.message)
          }
        })
      } catch (e) {
        setResult('translate', false, `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${e.message}`)
      }
      btn.disabled = false
    })

    // ---------- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§é–‹ã ----------
    document.getElementById('openPlayerBtn').addEventListener('click', () => {
      window.electronAPI.openPlayer({
        videoPath,
        origSrt: origSrtPath,
        jpSrt:   jpSrtPath,
      })
    })

    // ---------- å­—å¹•ç”Ÿæˆæ¸ˆã¿ã®å‹•ç”»ã‚’ç›´æ¥ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§é–‹ã ----------
    document.getElementById('directPlayerBtn').addEventListener('click', () => {
      window.electronAPI.openPlayer({})
    })
  </script>
</body>
</html>
